app-id: ca.dcloud.ICAClient
runtime: org.gnome.Platform
runtime-version: '40'
sdk: org.gnome.Sdk
command: /app/bin/run.sh

finish-args:
  - --device=all  #For webcam/microphone access. Future work will be to remove this permission, and replace with a more restrictive one for those devices only
  - --share=network
  - --socket=pulseaudio
  - --socket=x11 
  - --share=ipc #Required for X11 to work properly
  - --env=ICAROOT=$HOME/ICAClient/linuxx64 
  - --socket=wayland
  - --persist=. #Gives the app a persistent that is treated as the home directory, located at ~/.var/app/ca.dcloud.ICAClient
  - --persist=ICAClient #Installation directory (relative to the Flatpak container home folder)
  - --persist=.ICAClient #Log/config directory (relative to the Flatpak container home folder)

modules: #Requirements as per Citrix's site, that aren't included in the Flatpak runtime. https://docs.citrix.com/en-us/citrix-workspace-app-for-linux/system-requirements.html
  - name: gtk2  
    buildsystem: autotools
    sources:
       - type: archive
         url: http://archive.ubuntu.com/ubuntu/pool/main/g/gtk+2.0/gtk+2.0_2.24.33.orig.tar.xz
         sha256: ac2ac757f5942d318a311a54b0c80b5ef295f299c2a73c632f6bfb1ff49cc6da         
   
  #- name: atk-bridge
    #buildsystem: meson
    #sources:
       #- type: archive
         #url: http://archive.ubuntu.com/ubuntu/pool/main/a/at-spi2-atk/at-spi2-atk_2.38.0.orig.tar.xz
         #sha256: cfa008a5af822b36ae6287f18182c40c91dd699c55faa38605881ed175ca464f

  - name: libjson-c #Listed as a requirement "for instrumentation", not sure what that refers to
    buildsystem: cmake
    sources:
       - type: archive
         url: http://archive.ubuntu.com/ubuntu/pool/main/j/json-c/json-c_0.15.orig.tar.gz
         sha256: 4ba9a090a42cf1e12b84c64e4464bb6fb893666841d5843cc5bef90774028882

  - name: libxerces-c #Listed as a requirement for the self-service UI
    buildsystem: autotools
    sources:
       - type: archive
         url: http://archive.ubuntu.com/ubuntu/pool/universe/x/xerces-c/xerces-c_3.2.3+debian.orig.tar.xz
         sha256: 25652e6ed8a55e9273d6514f7e2744678b6d51f5d88c03d4219fac0310393f8d  

  - name: gst-plugins-ugly  #Listed as requirement for HDX RT video compression and MediaStream Windows media redirection
    buildsystem: meson
    sources:
       - type: archive
         url: https://gstreamer.freedesktop.org/src/gst-plugins-ugly/gst-plugins-ugly-1.16.3.tar.xz
         sha256: 403c21688065f41e53008874402b5c07832567cc1309a60df597eab7ff5843f0

  # - name: canberra-gtk
  #   buildsystem: autotools
  #   sources:
  #      - type: archive
  #        url: http://archive.ubuntu.com/ubuntu/pool/main/libc/libcanberra/libcanberra_0.30.orig.tar.xz
  #        sha256: c2b671e67e0c288a69fc33dc1b6f1b534d07882c2aceed37004bf48c601afa72   

  - name: gnome-keyring #Listed as a requirement for Service Continuity
    buildsystem: simple
    build-commands:
       - |
         ./configure --prefix=/app --with-pkcs11-config=/app/share/p11-kit/modules --with-pkcs11-modules=/app/share/p11-kit/modules
         make
         make install
    sources:
       - type: archive
         url: http://archive.ubuntu.com/ubuntu/pool/main/g/gnome-keyring/gnome-keyring_3.36.0.orig.tar.xz
         sha256: a264b57a8d1a71fdf0d66e8cd6033d013fb828be279c35766545eb9bb3734f87

  # - name: perl
  #   sources:
  #     - type: archive
  #       url: "http://www.cpan.org/src/5.0/perl-5.32.0.tar.gz"
  #       sha256: efeb1ce1f10824190ad1cadbcccf6fdb8a5d37007d0100d2d9ae5f2b5900c0b4
  #     - type: script
  #       dest-filename: configure
  #       commands:
  #         - ./Configure -des -Dprefix=/app
  #   post-install:
  #     - "find /app/lib/perl5 -type f -exec chmod u+w {} \\;"
        
  # - name: openssl
  #   buildsystem: simple
  #   build-commands:
  #     - |
  #       ./config --prefix=/app
  #       make
  #       make test
  #       PREFIX=/app make install
  #   sources:
  #     - type: archive
  #       url: http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/openssl_1.1.1j.orig.tar.gz
  #       sha256: aaf2fcb575cdf6491b98ab4829abf78a3dec8402b8b81efc8f23c00d443981bf

  #- name: binutils
    #buildsystem: autotools
    #sources:
       #- type: archive
         #url: https://ftp.wayne.edu/gnu/binutils/binutils-2.37.tar.xz
         #sha256: 820d9724f020a3e69cb337893a0b63c2db161dadcb0e06fc11dc29eb1e84a32c

  - name: ICAClient
    buildsystem: simple
    build-commands:
      - |
        mkdir -p /app/icaclient
        cp -r * /app/icaclient
        mkdir -p /app/share/icons/hicolor/64x64/apps
        cp /app/icaclient/linuxx64/linuxx64.cor/icons/000_Receiver_64.png /app/share/icons/hicolor/64x64/apps/ca.dcloud.ICAClient.png
        mkdir -p /app/share/icons/hicolor/256x256/apps
        cp /app/icaclient/linuxx64/linuxx64.cor/icons/receiver.png /app/share/icons/hicolor/256x256/apps/ca.dcloud.ICAClient.png
    sources:
      - type: archive
        url: https://downloads.citrix.com/19785/linuxx64-21.8.0.40.tar.gz?__gda__=exp=1629678036~acl=/*~hmac=4195d02903314527b6e92038687f3296b32d19aa436328a590ad1568a9677bf7
        sha256: 69ddae29cc8b4b68341c3d9503a54ee70ab58a5795fd83e79573f013eda5518c #checksum is for Workspace 2108 Linux x86_64 tarball

  - name: HDX-RTME
    buildsystem: simple
    build-commands:
      - |
        unzip HDX_RealTime_Media_Engine_\*_for_Linux_x64.zip -d HDX-RTME
        cp -r HDX-RTME/HDX*/* /app/icaclient
        cd /app/icaclient/x86_64
        ar -x citrix-hdx-realtime-media-engine_*_amd64.deb
        tar -xf data.tar.xz
    sources:
      - type: file
        url: https://downloads.citrix.com/11922/HDX_RealTime_Media_Engine_2.9.400_for_Linux_x64.zip?__gda__=exp=1629678068~acl=/*~hmac=85e4c1b0718d6c8b2b964c7c42a972b40b2fdbae7792b1d887530d5115f37629
        sha256: 796b2b3d080fa9e78babda473a074fa5be7b5214469e4fb5910fc270bff44241  #checksum is for HDX RTME 2.9.400 for Linux x64 .zip

  - name: Run-script
    buildsystem: simple
    build-commands:
      - |
        cp ./run.sh /app/bin/
        chmod +x /app/bin/run.sh
    sources:
      - type: file
        path: ./run.sh  

  - name: Appdata-xml
    buildsystem: simple
    build-commands:
      - |
        mkdir -p /app/share/metainfo
        cp ./ca.dcloud.ICAClient.appdata.xml /app/share/metainfo/
        appstream-util validate-relax /app/share/metainfo/ca.dcloud.ICAClient.appdata.xml
    sources:
      - type: file
        path: ./ca.dcloud.ICAClient.appdata.xml

  - name: Desktop-file
    buildsystem: simple
    build-commands:
      - |
        mkdir -p /app/share/applications
        cp ./ca.dcloud.ICAClient.desktop /app/share/applications/
        desktop-file-validate /app/share/applications/ca.dcloud.ICAClient.desktop
    sources:
      - type: file
        path: ./ca.dcloud.ICAClient.desktop